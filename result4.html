<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
</head>

<body>
    <div class="ui container">
        <div id="experiment" class="ui top aligned centered relaxed grid">
            <script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
            <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
            <script type="text/javascript" src="https://cdn.jsdelivr.net/mark.js/8.6.0/mark.min.js"></script>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
                integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
                crossorigin="anonymous">
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
                crossorigin="anonymous"></script>
            <!-- <script src="https://cdn.jsdelivr.net/gh/CoyoteLeo/mturk@v0.10/relation.min.js"></script> -->
            <!-- <script src="https://cdn.jsdelivr.net/gh/CoyoteLeo/mturk@v0.10/span_label.min.js"></script> -->
            <script src="relation.min.js"></script>
            <script src="span_label.min.js"></script>
            <style>
                .flex-container {
                    display: flex;
                    flex-direction: row;
                    margin-top: 30px;
                    justify-content: space-between;
                }

                .flex-item {
                    text-align: justify;
                    width: 48%;
                }

                [class*="retold_mark"] {
                    background: lightgreen;
                    padding: .1em;
                }

                [class*="recalled_mark"] {
                    background: lightskyblue;
                    padding: .1em;
                }

                table {
                    table-layout: fixed;
                }

                .result {
                    margin-top: 50px;
                }

                tr>td {
                    vertical-align: baseline;
                }

                h3 {
                    margin-top: 30px;
                }

                input,
                select {
                    width: 100%;
                }
            </style>
            <div style="text-align: center; margin:30px auto 200px auto">
                <a id='instruction_btn' href="https://coyoteleo.github.io/mturk/instruction.html"
                    class="btn btn-primary" target="_blank" onclick="start_span_labeling()">View instructions before
                    labeling</a>
                <hr>
                <div id="span_labeling">
                    <div style="text-align: justify;">
                        <h4 style="text-align: center;padding: 8px;">Summary</h4>
                        This story is about a canoe float with grandpa. We had a great float trip with my dad but were
                        saddened to realize how
                        bad his Alzheimer's really is.
                    </div>
                    <table class='table'>
                        <tr>
                            <th style="width: 50%;">Recalled story</th>
                            <th style="width: 10px;"></th>
                            <th style="width: 50%;">Retold story</th>
                        </tr>
                        <tbody style="border-color: black;">
                            <tr>
                                <td id='recalled' style="text-align: justify;">
                                </td>
                                <td></td>
                                <td id='retold' style="text-align: justify;">
                                </td>
                            </tr>
                            <tr>
                                <td id='recalled_result' class='result'></td>
                                <td></td>
                                <td id='retold_result' class='result'></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button id='relation_btn' class="btn btn-primary" type="button" onclick="start_relation_tagging()"
                    style="display: none;">Start Relation Tagging</button>
                <div id="relation_labeling">
                    <div id='pair_form' novalidate style="width: 80%;margin: auto;">
                        <h4>Relation Result</h4>
                        <table class='table table-bordered'>
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 130px;">Type</th>
                                    <th scope="col" style="calc(50% - 105px)">recalled IDs</th>
                                    <th scope="col" style="calc(50% - 105px)">retold IDs</th>
                                    <th scope="col" style="width: 80px;">Delete</th>
                                </tr>
                            </thead>
                            <tbody id='relation_result'>
                            </tbody>
                        </table>
                    </div>
                    <div novalidate
                        style="width: 70%;z-index: 999;position: fixed;bottom: 5px;background: white;border: 2px black solid;left: 0;right: 0;margin: auto">
                        <table class='table'>
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 130px;">Type</th>
                                    <th scope="col" style="calc(50% - 105px)">recalled IDs</th>
                                    <th scope="col" style="calc(50% - 105px)">retold IDs</th>
                                    <th scope="col" style="width: 80px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="has-validation">
                                            <select id="type_selection" class="form-select"
                                                onchange="validate_relation()">
                                                <option disabled selected>--</option>
                                                <option value="match">Match</option>
                                                <option value="conflict">Conflict</option>
                                                <option value="added">Added</option>
                                            </select>
                                            <div class="invalid-feedback">Please select a valid type.</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="has-validation">
                                            <input id="recalled_ids" type="text" class="form-control"
                                                pattern="^\d+(,\d+)*$" placeholder="e.g. 1,2,5" data-id-type='recalled'
                                                oninput="validate_relation()">
                                            <div class="invalid-feedback">Please fill the field with the correct
                                                pattern.</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="has-validation">
                                            <input id="retold_ids" type="text" class="form-control"
                                                pattern="^\d+(,\d+)*$" placeholder="e.g. 1,2,5" data-id-type='retold'
                                                oninput="validate_relation()">
                                            <div class="invalid-feedback">Please fill the field with the correct
                                                pattern.</div>
                                        </div>
                                    </td>
                                    <td><button type="button" class="btn btn-sm btn-success"
                                            style="background-color: #198754" onclick="add_relation()">Added</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <crowd-form onsubmit="return validate_submit()">
                            <crowd-text-area id="final_id" name="id" rows="4" style="display: none;">${recAgnPairId}
                            </crowd-text-area>
                            <crowd-text-area id="final_record" name="record" rows="4" style="display: none;">
                            </crowd-text-area>
                            <crowd-text-area id="final_relation" name="relation" rows="4" style="display: none;">
                            </crowd-text-area>
                            <h4>Opinion</h4>
                            <crowd-text-area id="opinion" name="opinion"
                                placeholder='There are something strange in the articles, ex: two article are totally different. '>
                            </crowd-text-area>
                        </crowd-form>
                    </div>
                </div>
            </div>
        </div>
        <script>
            function validate_submit() {
                const retold_ids = new Set(Object.keys(record.retold).map(x => parseInt(x)));
                let tagged_ids = new Set();
                for (const id in relations) {
                    for (const i in relations[id]['retold_ids']) {
                        tagged_ids = tagged_ids.add(parseInt(relations[id]['retold_ids'][i]));
                    }
                }
                tagged_ids = Array.from(tagged_ids);
                const lack_ids = Array.from(retold_ids).filter(x => !tagged_ids.includes(x));
                if ((lack_ids).length != 0) {
                    alert(`All span ids of retold story should be tagged with a relation, ${JSON.stringify(lack_ids)}`);
                    return false;
                }
                return true;
            }
            $(document).ready(() => {
                const result = [
                    {
                        "record": {
                            "recalled": {
                                "1": {
                                    "end": 89,
                                    "start": 0,
                                    "text": "A friend, let's call her G, took it upon herself to pay for a trip for my other friend, D"
                                },
                                "4": {
                                    "end": 150,
                                    "start": 98,
                                    "text": "dealing with a recent diagnosis of a stage 4 cancer."
                                },
                                "5": {
                                    "end": 277,
                                    "start": 163,
                                    "text": "I was the one who was doing all the day to day helping with doctor's appointments and taking care of stuff at home"
                                },
                                "6": {
                                    "end": 770,
                                    "start": 719,
                                    "text": "it was truly the most luxurious place I had been in"
                                },
                                "7": {
                                    "end": 1083,
                                    "start": 985,
                                    "text": "G wanted to place to be a surprise so only gave D and me the address but not the name of the hotel"
                                },
                                "8": {
                                    "end": 1175,
                                    "start": 1085,
                                    "text": "Everything was made out of recycled material, the suite was stunning with a beautiful view"
                                },
                                "9": {
                                    "end": 1235,
                                    "start": 1177,
                                    "text": "There were several pools to pick from as well as the ocean"
                                },
                                "10": {
                                    "end": 1306,
                                    "start": 1237,
                                    "text": "Every night we would walk around town and pick places to have a drink"
                                }
                            },
                            "retold": {
                                "2": {
                                    "end": 83,
                                    "start": 0,
                                    "text": "My friend D, who lives on the other coast wanted to pay for a trip for my friend M,"
                                },
                                "3": {
                                    "end": 134,
                                    "start": 92,
                                    "text": "recently diagnosed with a serious illness."
                                },
                                "11": {
                                    "end": 184,
                                    "start": 135,
                                    "text": "M had no time for anything but work and treatment"
                                },
                                "12": {
                                    "end": 374,
                                    "start": 301,
                                    "text": "I was doing the majority of the day to day care and doctor's appointments"
                                },
                                "13": {
                                    "end": 454,
                                    "start": 418,
                                    "text": "M wanted to pick a tropical location"
                                },
                                "14": {
                                    "end": 542,
                                    "start": 459,
                                    "text": "D paid for an accommodation at a place it would be easy enough for us all to get to"
                                },
                                "15": {
                                    "end": 619,
                                    "start": 590,
                                    "text": "D flew in from the West Coast"
                                },
                                "17": {
                                    "end": 673,
                                    "start": 624,
                                    "text": "M and I took the same flight from the East Coast."
                                },
                                "18": {
                                    "end": 794,
                                    "start": 711,
                                    "text": "M and I pulled up in the taxi and saw the hotel was more beautiful than we imagined"
                                },
                                "19": {
                                    "end": 960,
                                    "start": 856,
                                    "text": "There were several pools to choose from and well as being right on the beach so the ocean was steps away"
                                },
                                "20": {
                                    "end": 1043,
                                    "start": 962,
                                    "text": "At night we would go out or simply walk around in the beautiful tropical weather."
                                }
                            }
                        },
                        "relation": {
                            "1": {
                                "recalled_ids": [
                                    1
                                ],
                                "retold_ids": [
                                    2
                                ],
                                "type": "match"
                            },
                            "2": {
                                "recalled_ids": [
                                    4
                                ],
                                "retold_ids": [
                                    3
                                ],
                                "type": "match"
                            },
                            "3": {
                                "recalled_ids": [],
                                "retold_ids": [
                                    11
                                ],
                                "type": "added"
                            },
                            "4": {
                                "recalled_ids": [
                                    5
                                ],
                                "retold_ids": [
                                    12
                                ],
                                "type": "match"
                            },
                            "5": {
                                "recalled_ids": [],
                                "retold_ids": [
                                    13
                                ],
                                "type": "added"
                            },
                            "6": {
                                "recalled_ids": [],
                                "retold_ids": [
                                    14
                                ],
                                "type": "added"
                            },
                            "7": {
                                "recalled_ids": [],
                                "retold_ids": [
                                    15
                                ],
                                "type": "added"
                            },
                            "8": {
                                "recalled_ids": [],
                                "retold_ids": [
                                    17
                                ],
                                "type": "added"
                            },
                            "9": {
                                "recalled_ids": [],
                                "retold_ids": [
                                    18
                                ],
                                "type": "added"
                            },
                            "10": {
                                "recalled_ids": [
                                    6
                                ],
                                "retold_ids": [
                                    18
                                ],
                                "type": "match"
                            },
                            "11": {
                                "recalled_ids": [
                                    9
                                ],
                                "retold_ids": [
                                    19
                                ],
                                "type": "match"
                            },
                            "12": {
                                "recalled_ids": [
                                    10
                                ],
                                "retold_ids": [
                                    20
                                ],
                                "type": "match"
                            }
                        }
                    }
                ][0]
                document.querySelector("#recalled").dataset.text = `A friend, let's call her G, took it upon herself to pay for a trip for my other friend, D, who is dealing with a recent diagnosis of a stage 4 cancer. G felt that I was the one who was doing all the day to day helping with doctor's appointments and taking care of stuff at home. So the pasrt she felt she could best play considering she was rarely in our home state was to provide a trip to a warm place with a beach. This is exactly what D wanted. It was the first trip after D started treatment and it would just be the three of us. I felt lucky that this trip was provided by G. No matter what, it was going to be hard. I knew D atleast felt like she could be real about her frustrations and fears. When we arrived, it was truly the most luxurious place I had been in, which isn't important by itself. Obviously most people couldn't afford this and it's not the only way to deal with this diagnosis. But for three women who grew up not having access to this, it was pretty amazing. G wanted to place to be a surprise so only gave D and me the address but not the name of the hotel. Everything was made out of recycled material, the suite was stunning with a beautiful view. There were several pools to pick from as well as the ocean. Every night we would walk around town and pick places to have a drink. The memories of going on this trip are something I'll always be grateful for.`;
                document.querySelector("#retold").dataset.text = `My friend D, who lives on the other coast wanted to pay for a trip for my friend M, who was recently diagnosed with a serious illness. M had no time for anything but work and treatment but loved to travel. D felt bad about not being able to help her with anything from so far away. She also felt like I was doing the majority of the day to day care and doctor's appointments, so she wanted me to come on the trip too. M wanted to pick a tropical location. So D paid for an accommodation at a place it would be easy enough for us all to get to. We were each responsible for our own flights. D flew in from the West Coast and M and I took the same flight from the East Coast. D was already there when we arrived. M and I pulled up in the taxi and saw the hotel was more beautiful than we imagined. We could never imagine staying in a place like this before. There were several pools to choose from and well as being right on the beach so the ocean was steps away. At night we would go out or simply walk around in the beautiful tropical weather. We were able to just relax for awhile and give M a chance to breathe. It wasn't always an easy trip, given the reason we went but the memories were well worth it.`;
                let story_blocks = ["#recalled", "#retold"];
                story_blocks.forEach((story_type) => {
                    let e = $(story_type)[0];
                    e.innerHTML = e.dataset.text;
                    const t = story_type.substr(1);
                    l = result['record'][t];
                    for (const id in l) {
                        add_span(e, l[id]['text'], parseInt(id));
                    }
                });
                let table = document.querySelector("#relation_result");
                l = result['relation'];
                for (const id in l) {
                    r = l[id];
                    tr = document.createElement("tr");
                    tr.id = `relation${id}`;
                    relation_type = r['type']
                    recalled_table = build_html(r['recalled_ids'], record.recalled);
                    retold_table = build_html(r['retold_ids'], record.retold);
                    tr.innerHTML = `<td>${relation_type}</td><td>${recalled_table}</td><td>${retold_table}</td><td><button type="button" class="btn btn-sm btn-danger" style="background-color: #dc3545"onclick=delete_relation(${relation_counter})>X</button></td>`;
                    table.append(tr);
                    relations[relation_counter] = {
                        type: relation_type,
                        recalled_ids: r['recalled_ids'],
                        retold_ids: r['retold_ids'],
                    };
                    document.querySelector("#final_relation").value = relations;
                    relation_counter = parseInt(id) + 1;
                }


            });
        </script>
</body>

</html>