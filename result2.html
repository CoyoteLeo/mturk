<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
</head>

<body>
    <div class="ui container">
        <div id="experiment" class="ui top aligned centered relaxed grid">
            <script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
            <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
            <script type="text/javascript" src="https://cdn.jsdelivr.net/mark.js/8.6.0/mark.min.js"></script>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
                integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
                crossorigin="anonymous">
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
                crossorigin="anonymous"></script>
            <!-- <script src="https://cdn.jsdelivr.net/gh/CoyoteLeo/mturk@v0.10/relation.min.js"></script> -->
            <!-- <script src="https://cdn.jsdelivr.net/gh/CoyoteLeo/mturk@v0.10/span_label.min.js"></script> -->
            <script src="relation.min.js"></script>
            <script src="span_label.min.js"></script>
            <style>
                .flex-container {
                    display: flex;
                    flex-direction: row;
                    margin-top: 30px;
                    justify-content: space-between;
                }

                .flex-item {
                    text-align: justify;
                    width: 48%;
                }

                [class*="retold_mark"] {
                    background: lightgreen;
                    padding: .1em;
                }

                [class*="recalled_mark"] {
                    background: lightskyblue;
                    padding: .1em;
                }

                table {
                    table-layout: fixed;
                }

                .result {
                    margin-top: 50px;
                }

                tr>td {
                    vertical-align: baseline;
                }

                h3 {
                    margin-top: 30px;
                }

                input,
                select {
                    width: 100%;
                }
            </style>
            <div style="text-align: center; margin:30px auto 200px auto">
                <a id='instruction_btn' href="https://coyoteleo.github.io/mturk/instruction.html"
                    class="btn btn-primary" target="_blank" onclick="start_span_labeling()">View instructions before
                    labeling</a>
                <hr>
                <div id="span_labeling">
                    <div style="text-align: justify;">
                        <h4 style="text-align: center;padding: 8px;">Summary</h4>
                        This story is about a canoe float with grandpa. We had a great float trip with my dad but were
                        saddened to realize how
                        bad his Alzheimer's really is.
                    </div>
                    <table class='table'>
                        <tr>
                            <th style="width: 50%;">Recalled story</th>
                            <th style="width: 10px;"></th>
                            <th style="width: 50%;">Retold story</th>
                        </tr>
                        <tbody style="border-color: black;">
                            <tr>
                                <td id='recalled' style="text-align: justify;">
                                </td>
                                <td></td>
                                <td id='retold' style="text-align: justify;">
                                </td>
                            </tr>
                            <tr>
                                <td id='recalled_result' class='result'></td>
                                <td></td>
                                <td id='retold_result' class='result'></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button id='relation_btn' class="btn btn-primary" type="button" onclick="start_relation_tagging()"
                    style="display: none;">Start Relation Tagging</button>
                <div id="relation_labeling">
                    <div id='pair_form' novalidate style="width: 80%;margin: auto;">
                        <h4>Relation Result</h4>
                        <table class='table table-bordered'>
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 130px;">Type</th>
                                    <th scope="col" style="calc(50% - 105px)">recalled IDs</th>
                                    <th scope="col" style="calc(50% - 105px)">retold IDs</th>
                                    <th scope="col" style="width: 80px;">Delete</th>
                                </tr>
                            </thead>
                            <tbody id='relation_result'>
                            </tbody>
                        </table>
                    </div>
                    <div novalidate
                        style="width: 70%;z-index: 999;position: fixed;bottom: 5px;background: white;border: 2px black solid;left: 0;right: 0;margin: auto">
                        <table class='table'>
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 130px;">Type</th>
                                    <th scope="col" style="calc(50% - 105px)">recalled IDs</th>
                                    <th scope="col" style="calc(50% - 105px)">retold IDs</th>
                                    <th scope="col" style="width: 80px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="has-validation">
                                            <select id="type_selection" class="form-select"
                                                onchange="validate_relation()">
                                                <option disabled selected>--</option>
                                                <option value="match">Match</option>
                                                <option value="conflict">Conflict</option>
                                                <option value="added">Added</option>
                                            </select>
                                            <div class="invalid-feedback">Please select a valid type.</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="has-validation">
                                            <input id="recalled_ids" type="text" class="form-control"
                                                pattern="^\d+(,\d+)*$" placeholder="e.g. 1,2,5" data-id-type='recalled'
                                                oninput="validate_relation()">
                                            <div class="invalid-feedback">Please fill the field with the correct
                                                pattern.</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="has-validation">
                                            <input id="retold_ids" type="text" class="form-control"
                                                pattern="^\d+(,\d+)*$" placeholder="e.g. 1,2,5" data-id-type='retold'
                                                oninput="validate_relation()">
                                            <div class="invalid-feedback">Please fill the field with the correct
                                                pattern.</div>
                                        </div>
                                    </td>
                                    <td><button type="button" class="btn btn-sm btn-success"
                                            style="background-color: #198754" onclick="add_relation()">Added</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <crowd-form onsubmit="return validate_submit()">
                            <crowd-text-area id="final_id" name="id" rows="4" style="display: none;">${recAgnPairId}
                            </crowd-text-area>
                            <crowd-text-area id="final_record" name="record" rows="4" style="display: none;">
                            </crowd-text-area>
                            <crowd-text-area id="final_relation" name="relation" rows="4" style="display: none;">
                            </crowd-text-area>
                            <h4>Opinion</h4>
                            <crowd-text-area id="opinion" name="opinion"
                                placeholder='There are something strange in the articles, ex: two article are totally different. '>
                            </crowd-text-area>
                        </crowd-form>
                    </div>
                </div>
            </div>
        </div>
        <script>
            function validate_submit() {
                const retold_ids = new Set(Object.keys(record.retold).map(x => parseInt(x)));
                let tagged_ids = new Set();
                for (const id in relations) {
                    for (const i in relations[id]['retold_ids']) {
                        tagged_ids = tagged_ids.add(parseInt(relations[id]['retold_ids'][i]));
                    }
                }
                tagged_ids = Array.from(tagged_ids);
                const lack_ids = Array.from(retold_ids).filter(x => !tagged_ids.includes(x));
                if ((lack_ids).length != 0) {
                    alert(`All span ids of retold story should be tagged with a relation, ${JSON.stringify(lack_ids)}`);
                    return false;
                }
                return true;
            }
            $(document).ready(() => {
                const result = [
                    {
                        "record": {
                            "recalled": {
                                "1": {
                                    "end": 35,
                                    "start": 0,
                                    "text": "My niece lives about 350 miles away"
                                },
                                "6": {
                                    "end": 352,
                                    "start": 282,
                                    "text": "When religion does come up, she tunes herself out of the conversation."
                                },
                                "7": {
                                    "end": 477,
                                    "start": 432,
                                    "text": "My wife and I were taking her school shopping"
                                },
                                "9": {
                                    "end": 580,
                                    "start": 483,
                                    "text": "she is actually the one who brought up something she thought was derogatory to women in the bible"
                                },
                                "10": {
                                    "end": 677,
                                    "start": 622,
                                    "text": "I was able to explain what the scripture actually meant"
                                },
                                "11": {
                                    "end": 714,
                                    "start": 679,
                                    "text": "She was hesitant to listen at first"
                                },
                                "12": {
                                    "end": 764,
                                    "start": 720,
                                    "text": "I could tell that I had piqued her interest."
                                },
                                "13": {
                                    "end": 817,
                                    "start": 765,
                                    "text": "She quickly changed the subject after my explanation"
                                },
                                "14": {
                                    "end": 973,
                                    "start": 933,
                                    "text": "they took the scriptures out of context."
                                },
                                "15": {
                                    "end": 924,
                                    "start": 826,
                                    "text": "she didn't like the true meaning rather than the meaning she and her friends had chosen to believe"
                                }
                            },
                            "retold": {
                                "16": {
                                    "end": 317,
                                    "start": 275,
                                    "text": "I took my niece shopping a few months back"
                                },
                                "17": {
                                    "end": 367,
                                    "start": 319,
                                    "text": "she brought up something that was from the bible"
                                },
                                "18": {
                                    "end": 485,
                                    "start": 417,
                                    "text": "she did have to mention a certain custom that was found in the bible"
                                },
                                "19": {
                                    "end": 586,
                                    "start": 498,
                                    "text": "she took a worldly view of it rather than read the entire book to understand the context"
                                },
                                "20": {
                                    "end": 652,
                                    "start": 588,
                                    "text": "I was able to explain what the snippet she shared actually meant"
                                },
                                "21": {
                                    "end": 672,
                                    "start": 654,
                                    "text": "She rarely listens"
                                },
                                "22": {
                                    "end": 792,
                                    "start": 731,
                                    "text": "she was the one who brought it up so I did have her attention"
                                }
                            }
                        },
                        "relation": {
                            "1": {
                                "recalled_ids": [
                                    7
                                ],
                                "retold_ids": [
                                    16
                                ],
                                "type": "match"
                            },
                            "3": {
                                "recalled_ids": [
                                    9
                                ],
                                "retold_ids": [
                                    17,
                                    18
                                ],
                                "type": "match"
                            },
                            "4": {
                                "recalled_ids": [
                                    10
                                ],
                                "retold_ids": [
                                    20
                                ],
                                "type": "match"
                            },
                            "5": {
                                "recalled_ids": [
                                    11
                                ],
                                "retold_ids": [
                                    21
                                ],
                                "type": "match"
                            },
                            "6": {
                                "recalled_ids": [
                                    12
                                ],
                                "retold_ids": [
                                    22
                                ],
                                "type": "match"
                            },
                            "7": {
                                "recalled_ids": [
                                    14
                                ],
                                "retold_ids": [
                                    19
                                ],
                                "type": "match"
                            }
                        }
                    }
                ][0]
                document.querySelector("#recalled").dataset.text = `My niece lives about 350 miles away so we do not get to see each other in person very often. Faith is the most important thing in my life, and family is a very close second. My niece is not spiritual at all, nor religious. She is a typical teenager who thinks she knows everything. When religion does come up, she tunes herself out of the conversation. She was visiting not long ago, and naturally religion came up in conversation. My wife and I were taking her school shopping, and she is actually the one who brought up something she thought was derogatory to women in the bible. That opened up the conversation because I was able to explain what the scripture actually meant. She was hesitant to listen at first, but I could tell that I had piqued her interest. She quickly changed the subject after my explanation because she didn't like the true meaning rather than the meaning she and her friends had chosen to believe because they took the scriptures out of context. That was okay though. She is a smart kid, and I know she is going to ponder on what I told her. I don't push religion on her at all because I know she puts those walls up. I love moments like this though because they are so few and far between. I am able to plant seeds that I know are going to be watered by the Lord, and that just thrills me to no end.`;
                document.querySelector("#retold").dataset.text = `I have struggled to tell my family about the gospel. It is not that I don't want to. It is just because they are not receptive to it. I know I cannot shove it down their throats because they will build a wall so quick to block it out. I have to be more subtle about it. When I took my niece shopping a few months back, she brought up something that was from the bible. She was not having a biblical conversation, but she did have to mention a certain custom that was found in the bible. Naturally, she took a worldly view of it rather than read the entire book to understand the context. I was able to explain what the snippet she shared actually meant. She rarely listens when I am able to share something with her like this, but she was the one who brought it up so I did have her attention. It was like only climbing a foot up a 1,000 foot wall as far as progress goes, but this was much better than declining, which is usually what happens. I hope to have more chances in the future, but I know they will be hard to find. I am encouraged though by this. It means that she will be open once again to hear the gospel since she was this time. I just hope that I can get the rest of the family, and her, on board!`;
                let story_blocks = ["#recalled", "#retold"];
                story_blocks.forEach((story_type) => {
                    let e = $(story_type)[0];
                    e.innerHTML = e.dataset.text;
                    const t = story_type.substr(1);
                    l = result['record'][t];
                    for (const id in l) {
                        add_span(e, l[id]['text'], parseInt(id));
                    }
                });
                let table = document.querySelector("#relation_result");
                l = result['relation'];
                for (const id in l) {
                    r = l[id];
                    tr = document.createElement("tr");
                    tr.id = `relation${id}`;
                    relation_type = r['type']
                    recalled_table = build_html(r['recalled_ids'], record.recalled);
                    retold_table = build_html(r['retold_ids'], record.retold);
                    tr.innerHTML = `<td>${relation_type}</td><td>${recalled_table}</td><td>${retold_table}</td><td><button type="button" class="btn btn-sm btn-danger" style="background-color: #dc3545"onclick=delete_relation(${relation_counter})>X</button></td>`;
                    table.append(tr);
                    relations[relation_counter] = {
                        type: relation_type,
                        recalled_ids: r['recalled_ids'],
                        retold_ids: r['retold_ids'],
                    };
                    document.querySelector("#final_relation").value = relations;
                    relation_counter = parseInt(id) + 1;
                }


            });
        </script>
</body>

</html>